name: _smoke-env

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Install yq (pinned)
        run: |
          set -euo pipefail
          YQ_VERSION=v4.44.1
          curl -sSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Read hosts + expected url-service version
        id: read
        run: |
          set -euo pipefail
          FILE="envs/${{ inputs.env }}/values.yaml"

          API_HOST="$(yq -r '.ingress.hosts.api' "$FILE")"
          REDIRECT_HOST="$(yq -r '.ingress.hosts.redirect' "$FILE")"
          ANALYTICS_HOST="$(yq -r '.ingress.hosts.analytics' "$FILE")"
          URL_TAG="$(yq -r '.images.urlService.tag' "$FILE")"

          echo "api_host=$API_HOST" >> "$GITHUB_OUTPUT"
          echo "redirect_host=$REDIRECT_HOST" >> "$GITHUB_OUTPUT"
          echo "analytics_host=$ANALYTICS_HOST" >> "$GITHUB_OUTPUT"
          echo "url_tag=$URL_TAG" >> "$GITHUB_OUTPUT"

          echo "Env: ${{ inputs.env }}"
          echo "API_HOST=$API_HOST"
          echo "REDIRECT_HOST=$REDIRECT_HOST"
          echo "ANALYTICS_HOST=$ANALYTICS_HOST"
          echo "Expected url-service tag=$URL_TAG"

      - name: Smoke test (wait for rollout + verify version + e2e)
        env:
          API_HOST: ${{ steps.read.outputs.api_host }}
          REDIRECT_HOST: ${{ steps.read.outputs.redirect_host }}
          ANALYTICS_HOST: ${{ steps.read.outputs.analytics_host }}
          EXPECTED_URL_TAG: ${{ steps.read.outputs.url_tag }}
          ENV_NAME: ${{ inputs.env }}
        run: |
          set -euo pipefail

          # Use HTTPS only for prod (TLS requires hostname in URL)
          SCHEME="http"
          if [[ "${ENV_NAME}" == "prod" ]]; then
            SCHEME="https"
          fi

          API_BASE="${SCHEME}://${API_HOST}"
          REDIRECT_BASE="${SCHEME}://${REDIRECT_HOST}"
          ANALYTICS_BASE="${SCHEME}://${ANALYTICS_HOST}"
          TEST_URL="https://httpbin.org/status/200"

          # Retry helper
          retry_until_deadline() {
            local deadline_epoch="$1"; shift
            local delay=10
            until "$@"; do
              if (( $(date +%s) >= deadline_epoch )); then
                echo "âŒ Command failed before deadline: $*"
                return 1
              fi
              sleep "$delay"
            done
          }

          # Budget: ~17 minutes total (job timeout is 20m)
          deadline=$(( $(date +%s) + 17*60 ))

          # Function: Check url-service health and version
          check_url_service_health() {
            local response
            if ! response=$(curl -fsS --max-time 8 "${API_BASE}/health" 2>&1); then
              echo "Curl failed: ${response}"
              return 1
            fi

            # Validate JSON
            if ! echo "$response" | jq -e . >/dev/null 2>&1; then
              echo "Response is not valid JSON yet, retrying..."
              return 1
            fi

            echo "$response" | jq .
            
            local version
            version="$(echo "$response" | jq -r .version)"
            echo "Found version: ${version}, expected: ${EXPECTED_URL_TAG}"
            
            if [[ "$version" != "${EXPECTED_URL_TAG}" ]]; then
              echo "âŒ Version mismatch!"
              return 1
            fi
            
            echo "âœ… Health check passed with correct version"
            return 0
          }

          echo "==> Waiting for url-service health check..."
          retry_until_deadline "$deadline" check_url_service_health

          # Create short URL
          echo "==> Creating short URL..."
          code=$(curl -fsS --max-time 8 \
            -H "content-type: application/json" \
            -X POST "${API_BASE}/urls" \
            -d "{\"long_url\":\"${TEST_URL}\"}" \
            | jq -r .code)

          if [[ -z "$code" || "$code" == "null" ]]; then
            echo "âŒ Failed to create short URL"
            exit 1
          fi
          echo "Created short URL with code: ${code}"

          # Function: Verify redirect
          check_redirect() {
            local final_url
            
            # Follow redirects and get final destination
            if ! final_url=$(curl -fsSL --max-time 8 \
              -w "%{url_effective}" \
              -o /dev/null \
              "${REDIRECT_BASE}/r/${code}" 2>&1); then
              echo "âŒ Redirect check failed"
              return 1
            fi

            # Normalize both (in case destination URL redirects)
            final_url="${final_url%/}"
            local expected="${TEST_URL%/}"
            
            if [[ "$final_url" != "${expected}" ]]; then
              echo "Redirected to: ${final_url}, expected: ${expected}"
              return 1
            fi
            
            echo "âœ… Redirect working -> ${final_url}"
            return 0
          }

          echo "==> Verifying redirect..."
          retry_until_deadline "$deadline" check_redirect

          # Function: Verify analytics
          check_analytics() {
            local response
            if ! response=$(curl -fsS --max-time 8 "${ANALYTICS_BASE}/stats/${code}" 2>&1); then
              echo "Analytics check failed: ${response}"
              return 1
            fi

            # Validate JSON
            if ! echo "$response" | jq -e . >/dev/null 2>&1; then
              echo "Analytics response is not valid JSON yet, retrying..."
              return 1
            fi

            echo "$response" | jq .
            
            local count
            count=$(echo "$response" | jq -r .count)

            # Check if it's a valid integer
            if ! [[ "$count" =~ ^[0-9]+$ ]]; then
              echo "Invalid count value: '${count}' (not a number)"
              return 1
            fi
            
            if [[ "$count" -lt 1 ]]; then
              echo "Analytics count is ${count}, expected >= 1"
              return 1
            fi
            
            echo "âœ… Analytics tracking working (count: ${count})"
            return 0
          }

          echo "==> Verifying analytics..."
          retry_until_deadline "$deadline" check_analytics

          echo ""
          echo "ðŸŽ‰ All smoke tests passed for env=${ENV_NAME}"
          echo "   - url-service version: ${EXPECTED_URL_TAG}"
          echo "   - Short URL created: ${code}"
          echo "   - Redirect verified"
          echo "   - Analytics tracked"